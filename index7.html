<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­AIäº’åŠ¨æ•™ç»ƒ - ä¸ªäººç‰ˆ</title>
    <script src="https://cdn.staticfile.org/kuroshiro/1.2.0/kuroshiro.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #00cec9; --highlight: #fff200; --bg: #f8f9fc; }
        body { font-family: 'Helvetica Neue', Arial, "Hiragino Sans", sans-serif; background: var(--bg); padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; border-radius: 24px; padding: 25px; width: 100%; max-width: 550px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        
        /* é¡¶éƒ¨è¾“å…¥åŒº */
        textarea { width: 100%; height: 70px; border-radius: 12px; border: 1.5px solid #eee; padding: 12px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; resize: none; }
        textarea:focus { border-color: var(--primary); outline: none; }

        /* çŠ¶æ€æç¤º */
        #status-bar { margin: 10px 0; font-size: 0.85rem; text-align: center; color: #666; min-height: 20px; }
        .loader { color: var(--primary); font-weight: bold; }

        /* å†…å®¹å±•ç¤ºåŒº */
        #display-area { font-size: 1.4rem; line-height: 2.6; margin: 15px 0; min-height: 200px; padding: 15px; border-radius: 15px; background: #fff; border: 1px solid #f0f0f0; }
        .sentence-unit { margin-bottom: 15px; padding: 10px; border-radius: 10px; border-left: 5px solid transparent; transition: 0.3s; }
        .sentence-unit.active-sent { border-left-color: var(--primary); background: #f1f0ff; }
        
        /* å•è¯æ ·å¼ */
        ruby { cursor: pointer; border-radius: 4px; padding: 0 3px; transition: 0.2s; }
        ruby:hover { background: #eee; }
        ruby.playing { background: var(--highlight); transform: scale(1.05); display: inline-block; }
        rt { user-select: none; color: #7f8c8d; }

        /* æŒ‰é’®è®¾è®¡ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        button { padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .btn-read { background: var(--accent); color: white; }
        .btn-record { background: #ff7675; color: white; }
        button:disabled { background: #ccc; opacity: 0.6; }
        
        #score-panel { margin-top: 15px; text-align: center; padding: 10px; border-radius: 10px; background: #e8f4fd; color: #2980b9; display: none; }
    </style>
</head>
<body>

<div class="card">
    <textarea id="input-text" placeholder="åœ¨æ­¤ç²˜è´´æ—¥è¯­æ–‡æœ¬ï¼ˆä¾‹å¦‚ NHK æ–°é—»æˆ–æ­Œè¯ï¼‰..."></textarea>
    <button id="init-btn" class="btn-main" onclick="handleProcess()">âœ¨ å¼€å§‹ AI è§£æ</button>
    <div id="status-bar">ç­‰å¾…è¾“å…¥...</div>

    <div id="display-area">è§£æåçš„å†…å®¹å°†æ”¯æŒç‚¹å‡»å•è¯å‘éŸ³ã€å…¨æ–‡é«˜äº®è¿½è¸ª...</div>

    <div id="score-panel">
        <div id="score-text">åŒ¹é…åº¦ï¼š0%</div>
        <div id="heard-text" style="font-size: 0.8rem; opacity: 0.8;"></div>
    </div>

    <div class="btn-group">
        <button class="btn-read" id="read-btn" onclick="startFullRead()" disabled>ğŸ”Š å…¨æ–‡èŒƒè¯»</button>
        <button class="btn-record" id="record-btn" onclick="startPractice()" disabled>ğŸ¤ é€å¥è·Ÿè¯»</button>
    </div>
</div>

<script>
    const kuroshiro = new Kuroshiro();
    let isReady = false;
    let sentences = [];
    let currentIdx = 0;

    // åˆå§‹åŒ–å¹¶å¤„ç†æ–‡æœ¬
    async function handleProcess() {
        const text = document.getElementById('input-text').value.trim();
        if (!text) return alert("è¯·è¾“å…¥æ—¥è¯­æ–‡æœ¬");

        const status = document.getElementById('status-bar');
        const initBtn = document.getElementById('init-btn');

        if (!isReady) {
            status.innerHTML = '<span class="loader">â³ æ­£åœ¨åŠ è½½ç¦»çº¿è¯å…¸ï¼ˆçº¦2MBï¼‰ï¼Œè¯·ç¨å€™...</span>';
            initBtn.disabled = true;

            try {
                // å°è¯•ä»æœ€å¿«çš„è·¯å¾„åŠ è½½è¯å…¸
                const analyzer = new KuromojiAnalyzer({ 
                    dictPath: "https://cdn.jsdelivr.net/gh/takuyaa/kuromoji.js@master/dict" 
                });
                await kuroshiro.init(analyzer);
                isReady = true;
                status.innerHTML = "âœ… å¼•æ“å°±ç»ªï¼";
            } catch (e) {
                console.error("é¦–é€‰è·¯å¾„å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨è·¯å¾„...", e);
                try {
                    const altAnalyzer = new KuromojiAnalyzer({ 
                        dictPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict" 
                    });
                    await kuroshiro.init(altAnalyzer);
                    isReady = true;
                    status.innerHTML = "âœ… å¤‡ç”¨å¼•æ“å°±ç»ªï¼";
                } catch (e2) {
                    status.innerHTML = "âŒ åŠ è½½å¤±è´¥ã€‚è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–åœ¨ Live Server ç¯å¢ƒæ‰“å¼€ã€‚";
                    initBtn.disabled = false;
                    return;
                }
            }
        }

        initBtn.disabled = false;
        document.getElementById('read-btn').disabled = false;
        document.getElementById('record-btn').disabled = false;
        processData(text);
    }

    // è§£ææ–‡æœ¬å¹¶æ ‡æ³¨
    async function processData(text) {
        const display = document.getElementById('display-area');
        display.innerHTML = "æ­£åœ¨ç”Ÿæˆäº’åŠ¨æ ‡æ³¨...";

        // æ–­å¥
        const rawSegments = text.split(/([ã€‚ï¼ï¼Ÿ\?\!])+/).filter(s => s.trim().length > 0);
        sentences = [];
        for (let i = 0; i < rawSegments.length; i += 2) {
            const sText = (rawSegments[i] + (rawSegments[i+1] || "")).trim();
            const html = await kuroshiro.convert(sText, { mode: "furigana", to: "hiragana" });
            sentences.push({ raw: sText, html: html });
        }

        renderDisplay();
    }

    // æ¸²æŸ“æ˜¾ç¤º
    function renderDisplay() {
        const display = document.getElementById('display-area');
        display.innerHTML = "";

        sentences.forEach((data, i) => {
            const div = document.createElement('div');
            div.className = 'sentence-unit';
            div.id = `s-${i}`;
            div.innerHTML = data.html;

            // ç‚¹å‡»å•è¯å‘éŸ³
            div.querySelectorAll('ruby').forEach(ruby => {
                ruby.onclick = (e) => {
                    e.stopPropagation();
                    const kanji = ruby.childNodes[0].textContent;
                    ruby.classList.add('playing');
                    speakAI(kanji, () => ruby.classList.remove('playing'));
                };
            });
            display.appendChild(div);
        });
    }

    // æœ—è¯»é€»è¾‘
    function speakAI(text, onEnd) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ja-JP';
        msg.rate = 0.85;
        if (onEnd) msg.onend = onEnd;
        window.speechSynthesis.speak(msg);
    }

    // å…¨æ–‡æœ—è¯»ï¼ˆå¸¦é«˜äº®ï¼‰
    function startFullRead() {
        let i = 0;
        function next() {
            if (i >= sentences.length) return;
            highlight(i);
            speakAI(sentences[i].raw, () => {
                i++;
                next();
            });
        }
        next();
    }

    // é€å¥è·Ÿè¯»
    function startPractice() {
        const target = sentences[currentIdx].raw;
        highlight(currentIdx);
        
        speakAI(target, () => {
            const btn = document.getElementById('record-btn');
            btn.innerText = "ğŸ¤ æ­£åœ¨å€¾å¬...";
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'ja-JP';
            rec.start();

            rec.onresult = (e) => {
                const heard = e.results[0][0].transcript;
                const score = calcScore(heard, target);
                
                const panel = document.getElementById('score-panel');
                panel.style.display = 'block';
                document.getElementById('score-text').innerText = `å¥å­ ${currentIdx+1} åŒ¹é…åº¦ï¼š${score}%`;
                document.getElementById('heard-text').innerText = `å¬åˆ°ï¼š${heard}`;

                if (score > 60) {
                    currentIdx = (currentIdx + 1) % sentences.length;
                    setTimeout(startPractice, 2000);
                }
            };
            rec.onend = () => {
                btn.innerText = "ğŸ¤ é€å¥è·Ÿè¯»";
            };
        });
    }

    function highlight(idx) {
        document.querySelectorAll('.sentence-unit').forEach(el => el.classList.remove('active-sent'));
        const target = document.getElementById(`s-${idx}`);
        if (target) {
            target.classList.add('active-sent');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function calcScore(s1, s2) {
        const clean = s => s.replace(/[^\u3040-\u9FAF]/g, "");
        const t1 = clean(s1), t2 = clean(s2);
        let m = 0;
        for (let c of t1) { if (t2.includes(c)) m++; }
        return Math.min(100, Math.round((m / Math.max(1, t2.length)) * 100));
    }
</script>

</body>
</html>